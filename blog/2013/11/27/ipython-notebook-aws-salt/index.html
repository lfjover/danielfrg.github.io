<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="author" content="Daniel Rodriguez">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
        <title>One-liner: Deploy python scipy stack with IPython notebook on AWS | Daniel Rodriguez</title>

        <link rel="alternate" type="application/atom+xml" title="Daniel Rodriguez blog atom feed" href="/feeds/all.atom.xml" />
        <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700' rel='stylesheet' type='text/css'>

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
        <link rel="stylesheet" href="/theme/css/pygments.css">
        <link rel="stylesheet" href="/theme/css/main.css">

    </head>

    <body>
        <header class="navbar navbar-static-top bs-docs-nav main-header">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand" href="/" title="Home" class="title">Daniel Rodriguez</a></li>
                </div>
                <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
                    <ul class="nav navbar-nav navbar-right">
                            <li><a href="/pages/about.html" title="About">About</a></li>
                            <li><a href="http://github.com/danielfrg" title="danielfrg's Github" rel="me">Github</a></li>
                            <li><a href="http://twitter.com/danielfrg" title="danielfrg Twitter" rel="me">Twitter</a></li>
                            <li><a href="/archives.html" title="Archive">Archives</a></li>
                            <li><a href="/feeds/all.atom.xml" title="danielfrg.github.io RSS feed" rel="me">RSS</a></li>
                    </ul>
                </nav>
            </div>
        </header>

<div class="container post">

    <article>
        <header>
            <h1>One-liner: Deploy python scipy stack with IPython notebook on AWS</h1>
            <time datetime="article.date.isoformat()" pubdate>November 27, 2013</time>
        </header>

        <div class="article_content">
            <p><strong>Problem:</strong> How many times have you needed to create a powerful EC2 instance with the the python scientific stack
installed and the ipython notebook running? I have to do this at least 2 or 3 times every week.</p>
<p>A simple solution is to have an AMI with all the libraries ready and create a new instance every time,
you can even have the ipython notebook as an upstart service in ubuntu so it runs when the instance is ready.
That was my previous solution, but that was before I learned <a href="http://saltstack.com/">salt</a>.</p>
<p>The problem with the AMI solution is that it gets dated really quickly and while update it is not hard, it is
annoying. Also having to login into AWS, look for the AMI and spin up and instance is annoying.</p>
<p><strong>Solution:</strong> <a href="http://saltstack.com/">Salt</a> + <a href="http://continuum.io/downloads">Anaconda</a> + <a href="http://www.vagrantup.com/">Vagrant</a></p>
<p>Salt will do the provisioning of the instance using states, that makes the updates of new instances simple as changing a YAML file.
Anaconda is the best python scientific distribution I have found and the conda package manager is the perfect solution to install the scientific libraries, I don't want to compile numpy and scipy every time I create the instances, that takes at least 30 minutes.
Vagrant is used to create the instance and provision it with salt using one command.</p>
<p>Install conda using a salt states is pretty easy because salt has support for pip, and conda is pip
installable (you have to run <code>conda init</code> after <code>pip install conda</code>) so is as simple as:</p>
<div class="highlight"><pre><span class="l-Scalar-Plain">pip-packages</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">pip.installed</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">root</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">names</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">conda</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">require</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">pkg</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">python-dev</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">pkg</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">python-pip</span>

<span class="l-Scalar-Plain">conda-check</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">cmd.run</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ubuntu</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;[</span><span class="nv"> </span><span class="s">-d</span><span class="nv"> </span><span class="s">/usr/conda-meta</span><span class="nv"> </span><span class="s">]</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">echo</span><span class="nv"> </span><span class="s">&#39;changed=no&#39;</span><span class="nv"> </span><span class="s">||</span><span class="nv"> </span><span class="s">echo</span><span class="nv"> </span><span class="s">&#39;changed=yes&#39;&quot;</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">stateful</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">require</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">pip</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">conda</span>

<span class="c1"># This will create some files into /usr, needs root</span>
<span class="l-Scalar-Plain">conda-init</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">cmd.wait</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">root</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;conda</span><span class="nv"> </span><span class="s">init&quot;</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">watch</span><span class="p-Indicator">:</span>
        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">cmd</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">conda-check</span>
</pre></div>


<p>The main issue was that salt didn't have support for conda, so I <a href="http://github.com/danielfrg/salt-conda/blob/master/conda.py">wrote my first salt module</a> to manage conda virtual environments using salt.
The code below will create a conda virtual env and
install the ipython-notebook, numpy, scipy and pandas libraries using the conda repository
also will install luigi (or any other python library you want) using regular pip.
All of this will be inside the conda virtual env, because you <strong>should</strong> use virtual envs.</p>
<div class="highlight"><pre><span class="l-Scalar-Plain">venv</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">conda.managed</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ubuntu</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">pkgs</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ipython-notebook,numpy,scipy,pandas,scikit-learn</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">require</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">cmd</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">conda-init</span>

<span class="l-Scalar-Plain">venv-pip</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">pip.installed</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ubuntu</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">names</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">luigi</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">bin_env</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/home/ubuntu/envs/venv/bin/pip</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">require</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">conda</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">venv</span>
</pre></div>


<p>I created another module to start the ipython notebook in the background since salt does not support this natively, the state looks like this:</p>
<div class="highlight"><pre><span class="l-Scalar-Plain">/home/vagrant/nbserver.pid</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">nbserver.start_server</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ip</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0.0.0.0</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">80</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">nb_dir</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/home/ubuntu/notebooks</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">require</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">conda</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">venv</span>
</pre></div>


<p>The final peace of the puzzle is how to spin up the instance quickly, Vagrant with the AWS provider is the solution.</p>
<p>Vagrant is mainly used for development, and I use it to develop this solution but it also has a nice
integration with AWS, so on the <code>Vagrantfile</code> you only need to change the AWS credentials and the
instance configuration.</p>
<div class="highlight"><pre><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="no">VAGRANTFILE_API_VERSION</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="c1"># AWS Provider</span>
  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:aws</span> <span class="k">do</span> <span class="o">|</span><span class="n">aws</span><span class="p">,</span> <span class="n">override</span><span class="o">|</span>
    <span class="n">aws</span><span class="o">.</span><span class="n">access_key_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">aws</span><span class="o">.</span><span class="n">secret_access_key</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">aws</span><span class="o">.</span><span class="n">keypair_name</span> <span class="o">=</span> <span class="s2">&quot;daniel_keypair&quot;</span>

    <span class="n">aws</span><span class="o">.</span><span class="n">security_groups</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;default&quot;</span><span class="o">]</span>
    <span class="n">aws</span><span class="o">.</span><span class="n">instance_type</span> <span class="o">=</span> <span class="s2">&quot;c3.xlarge&quot;</span>
    <span class="n">aws</span><span class="o">.</span><span class="n">availability_zone</span> <span class="o">=</span> <span class="s2">&quot;us-east-a&quot;</span>
    <span class="n">aws</span><span class="o">.</span><span class="n">ami</span> <span class="o">=</span> <span class="s2">&quot;ami-a73264ce&quot;</span>  <span class="c1"># Precise 12.04 64 bits</span>

    <span class="n">override</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;dummy&quot;</span>
    <span class="n">override</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="s2">&quot;ubuntu&quot;</span>
    <span class="n">override</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">private_key_path</span> <span class="o">=</span> <span class="s2">&quot;~/.ssh/my_keypair.pem&quot;</span>
  <span class="k">end</span>
</pre></div>


<p>How you only need to run <code>vagrant up --provider aws</code> and it will create an instance and provision it
with salt. Then just go to the URL of the EC2 instance and the notebook will be running in port 80.</p>
<p>NOTE: Be sure to use a security group with port 22 and 80 open</p>
<p>There are more things you can configure for your notebook such as passwords and more security, take a look <a href="https://gist.github.com/iamatypeofwalrus/5183133">here</a>. Also there are more solutions available
such as <a href="https://www.wakari.io/">Continnums Wakari</a> that I personally think is an overkill, I am sure is perfect for some people but not for me.</p>
<p>This solution gives you the notebook up and running in two minutes, and if you need more control on the instance you can just SSH to it and do whatever you want. Also you only pay the Amazon fees, so for my personal needs is the perfect solution.</p>
<p>The whole code is on github: <a href="https://github.com/danielfrg/salt-conda">salt conda module</a>, look in <code>example/ipythonnb</code></p>
        </div>

        <div class="meta">
            <div>
                    <a href="/tag/python.html" class="tag">python</a>
                    <a href="/tag/aws.html" class="tag">aws</a>
                    <a href="/tag/salt.html" class="tag">salt</a>
                    <a href="/tag/ipython-notebook.html" class="tag">ipython-notebook</a>
            </div>
            <div>
                <a id="comments-button" class="comments_btn" href="#disqus_thread">Show comments</a>
            </div>
        </div>
    </article>
</div>

<script type="text/javascript">
(function () {
    'use strict';

    // Global object
    var App = {};

    // Create button
    App.commentsButton = document.getElementById('comments-button');

    App.commentsButton.onclick = function () {
        // Remove button action on click
        App.commentsButton.onclick = function () {
        }

        // Create comments container
        App.disqusContainer = document.createElement('div');
        App.disqusContainer.setAttribute('id', 'disqus_thread');
        // App.disqusContainer.setAttribute('class', 'container');

        // Append container to body or div
        // document.body.appendChild( App.disqusContainer );
        var container = document.getElementsByClassName('container post')[0];
        container.appendChild(App.disqusContainer);

        // Your Disqus shortname
        App.disqus_shortname = 'danielfrg';

        // Embed Disqus
        var dsq = document.createElement('script');

        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + App.disqus_shortname + '.disqus.com/embed.js';

        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

        window.scrollTo(0, dsq.offsetTop - 200);
    };
})();
</script>

        <style type="text/css">.text_cell .prompt {
    display: none;
}

div.cell {
    padding: 0;
}

div.text_cell_render {
    padding: 0;
}

div.prompt {
    font-size: 13px;
}

div.input_prompt {
    padding: .7em 0.2em;
}

div.output_prompt {
    padding: .4em .2em;
}

div.input_area {
    margin: .2em 0.4em;
}

table.dataframe {
    font-family: Arial, sans-serif;
    font-size: 13px;
    line-height: 20px;
}
table.dataframe th, td {
    padding: 4px;
    text-align: left;
}</style>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-35523657-2', 'danielfrg.com');
  ga('send', 'pageview');

</script>

    </body>
</html>