<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>A not so basic neural network on python | Daniel Rodriguez</title>
        <meta name="author" content="Daniel Rodriguez">
        <meta name="description" content="Blog is written by Daniel Rodriguez. He writes about coding, python, data science and his projects.">
        <meta name="viewport" content="width=device-width">

        <link rel="alternate" type="application/atom+xml" title="Daniel Rodriguez blog atom feed"
              href="/feeds/all.atom.xml" />

        <link rel="stylesheet" href="/theme/css/normalize.min.css">
        <link rel="stylesheet" href="/theme/css/fonts/proximanova.css">
        <link rel="stylesheet" href="/theme/css/fonts/ss-social.css">
        <link rel="stylesheet" href="/theme/css/fonts/ss-standard.css">
        <link rel="stylesheet" href="/theme/css/pygments.css">
        <link rel="stylesheet" href="/theme/css/ipython.css">
        <link rel="stylesheet" href="/theme/css/main.css">
    </head>
    <body>
        <div class="header">
            <div class="navbar">
              <a href="/" class="ss-icon" title="home">home</a>
              <a href="/tags.html" class="ss-icon" title="tags">tag</a>
              <a href="http://about.me/danielfrg" class="ss-icon" title="about">user</a>
              <a href="http://twitter.com/danielfrg" class="ss-icon ss-social" title="on twitter">twitter</a>
              <a href="http://github.com/danielfrg" class="ss-icon ss-social" title="on github">octocat</a>
              <a href="/feeds/all.atom.xml" class="ss-icon ss-social" title="email me">rss</a>
              <a href="mailto:df.rodriguez143@gmail.com" class="ss-icon" title="email me">mail</a>
            </div>
        </div>

        <div id="content">
            <div class="post">
    <article>
        <header>
            <h1>A not so basic neural network on python</h1>
        </header>
        <div class='post-content'>
            <div class="ipynb"><div class="text_cell_render border-box-sizing rendered_html">
<p>My <a href="http://danielfrg.github.io/blog/2013/07/03/basic-neural-network-python/">previous post</a> on implementing a basic Neural Network on python got a lot of attention staying one whole day on HN front page. I was very happy about that but more about the <a href="https://news.ycombinator.com/item?id=5994851">feedback</a> I got. The community gave me a lot of tips and tricks on how to improve. So now I am presenting an improved version which supports multiple hidden layers and some optimization options. Maybe I can get some page-views by using the same topic :P</p>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>I kept reading a lot about Neural Networks mainly by watching some videos from <a href="https://class.coursera.org/neuralnets-2012-001/class/index">Geoffrey's Hinton Neural Network course</a> on coursera. Also reading more on <a href="http://deeplearning.net/tutorial/">deeplearning.net</a> and trying to read some papers. That last task was definitely the hardest one because of the complexity of the papers. If I cannot event read them I can just imagine how hard is to write them.</p>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>About the Neural networks course I did not like it as much as the Machine Learning course. The main reason is that I had to watch most videos 3 or 4 times before understanding (something). This is definitely my fault because the material is great but it focuses more on the theory (math) which I am not that good at and not on the implementation which I am more interested. But I take it as a learning experience and I will try to finish those videos.</p>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>Some people criticized (besides my orthography, sorry about my spanglish :P) that I did not used cross-validation or more complex dataset on my previous post. I agree that both things are needed but I am not trying to make this post as a scientific paper with complete benchmarks of different optimization algorithms I leave that to the researchers who have spent years studying neural networks.</p>
<p>My objective was to learn about them and to have some personal implementation of the algorithm, just to say that I have done it :P; but in on this case I am using the MNIST dataset to compare.</p>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<h2 class="ipynb">
  Implementation
</h2>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>I was very tempted to use <a href="http://deeplearning.net/software/theano/">theano</a> and but at the end I decide to keep using a pure numpy implementation.</p>
<p>It is defenitly possible (and not that hard neither that easy) to create a theano implementation and I like some of the ideas such as creating a class for each layer because it makes easier to combine and create different implementations. But besides that I still cannot see the value of using theano. Of course the speed up is important but I thing I prefer the <a href="http://numba.pydata.org/">Numba</a> approach.</p>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>The implementation is very similar to the previous post, the differences are:</p>
<ol>
<li>Supports multiple hidden layers is using a similar implementation as the previous post: changed the gradient calculation to a for loop.</li>
<li>Support for Minibach optimization, which is definitely a must have with bigger datasets.</li>
</ol>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[1]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[2]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="k">def</span> <span class="nf">build_network</span><span class="p">(</span><span class="n">layers</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[(</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[3]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="k">def</span> <span class="nf">pack_weigths</span><span class="p">(</span><span class="o">*</span><span class="n">weights</span><span class="p">):</span>
    <span class="n">tuples</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">theta</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">theta</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">tuples</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[4]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="k">def</span> <span class="nf">unpack_weigths_gen</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">weights_meta</span><span class="p">):</span>
    <span class="n">start_pos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">weights_meta</span><span class="p">:</span>
        <span class="n">end_pos</span> <span class="o">=</span> <span class="n">start_pos</span> <span class="o">+</span> <span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">start_pos</span><span class="p">:</span><span class="n">end_pos</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">layer</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">yield</span> <span class="n">theta</span>
        <span class="n">start_pos</span> <span class="o">=</span> <span class="n">end_pos</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[5]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="k">def</span> <span class="nf">unpack_weigths_gen_inv</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">weights_meta</span><span class="p">):</span>
    <span class="n">end_pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">weights_meta</span><span class="p">):</span>
        <span class="n">start_pos</span> <span class="o">=</span> <span class="n">end_pos</span> <span class="o">-</span> <span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">start_pos</span><span class="p">:</span><span class="n">end_pos</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">layer</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">yield</span> <span class="n">theta</span>
        <span class="n">end_pos</span> <span class="o">=</span> <span class="n">start_pos</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[6]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="k">def</span> <span class="nf">rand_init</span><span class="p">(</span><span class="n">weights_meta</span><span class="p">,</span> <span class="n">epsilon_init</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">weights_meta</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">epsilon_init</span> <span class="o">-</span> <span class="n">epsilon_init</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[7]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="k">def</span> <span class="nf">sigmoid</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">z</span><span class="p">)))</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[8]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">weights_meta</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">act_func</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            
    <span class="n">a_prev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">ones</span><span class="p">,</span> <span class="n">X</span><span class="p">))</span>  <span class="c"># Input layer</span>
    <span class="k">for</span> <span class="n">theta</span> <span class="ow">in</span> <span class="n">unpack_weigths_gen</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">weights_meta</span><span class="p">):</span>
        <span class="c"># Hidden Layers</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">a_prev</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">act_func</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">a_prev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">ones</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">a</span>  <span class="c"># Output layer</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[9]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="k">def</span> <span class="nf">sumsqr</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">a</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[10]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">weights_meta</span><span class="p">,</span> <span class="n">num_labels</span><span class="p">,</span> <span class="n">reg_lambda</span><span class="p">,</span> <span class="n">act_func</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">num_labels</span><span class="p">)[</span><span class="n">y</span><span class="p">]</span>
    
    <span class="n">h</span> <span class="o">=</span> <span class="n">forward</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">weights_meta</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">act_func</span><span class="p">)</span>
    <span class="n">costPositive</span> <span class="o">=</span> <span class="o">-</span><span class="n">Y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">costNegative</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Y</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">costPositive</span> <span class="o">-</span> <span class="n">costNegative</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span> <span class="o">/</span> <span class="n">m</span>
    
    <span class="k">if</span> <span class="n">reg_lambda</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sums_qr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">theta</span> <span class="ow">in</span> <span class="n">unpack_weigths_gen</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">weights_meta</span><span class="p">):</span>
            <span class="n">theta_filtered</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
            <span class="n">sums_qr</span> <span class="o">+=</span> <span class="n">sumsqr</span><span class="p">(</span><span class="n">theta_filtered</span><span class="p">)</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg_lambda</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">m</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">sums_qr</span><span class="p">)</span>
        <span class="n">J</span> <span class="o">=</span> <span class="n">J</span> <span class="o">+</span> <span class="n">reg</span>
    <span class="k">return</span> <span class="n">J</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[11]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="k">def</span> <span class="nf">function_prime</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">weights_meta</span><span class="p">,</span> <span class="n">num_labels</span><span class="p">,</span> <span class="n">reg_lambda</span><span class="p">,</span> <span class="n">act_func</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">num_labels</span><span class="p">)[</span><span class="n">y</span><span class="p">]</span>
    <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
    
    <span class="n">d_s</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">Deltas</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">weights_meta</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
        <span class="c"># Forward</span>
        <span class="n">a_prev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">ones</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span>  <span class="c"># Input layer</span>
        <span class="n">a_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">a_prev</span><span class="p">,</span> <span class="p">)</span>  <span class="c"># a_s[0] == a1</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">theta</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unpack_weigths_gen</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">weights_meta</span><span class="p">)):</span>
            <span class="c"># Hidden Layers</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">a_prev</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">act_func</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
            <span class="n">a_prev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">ones</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
            <span class="n">a_s</span> <span class="o">=</span> <span class="n">a_s</span> <span class="o">+</span> <span class="p">(</span><span class="n">a_prev</span><span class="p">,</span> <span class="p">)</span>
                
        <span class="c"># Backprop</span>
        <span class="n">d_prev</span> <span class="o">=</span> <span class="n">a_s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span>  <span class="c"># last d</span>
        <span class="n">d_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">d_prev</span><span class="p">,</span> <span class="p">)</span>  <span class="c"># d_s[0] == d2 </span>
        <span class="k">for</span> <span class="n">a_i</span><span class="p">,</span> <span class="n">theta</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">a_s</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">unpack_weigths_gen_inv</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">weights_meta</span><span class="p">)):</span>
            <span class="n">d_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">theta</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">d_prev</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">a_i</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">a_i</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
            <span class="n">d_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">d_new</span><span class="p">,</span> <span class="p">)</span> <span class="o">+</span> <span class="n">d_s</span>
            <span class="n">d_prev</span> <span class="o">=</span> <span class="n">d_new</span>
        <span class="k">for</span> <span class="n">d_i</span><span class="p">,</span> <span class="n">a_i</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">d_s</span><span class="p">),</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">a_s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Deltas</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
            <span class="n">Deltas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Deltas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">d_i</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">a_i</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
    
    <span class="n">thetas_gen</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">reg_lambda</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">thetas_gen</span> <span class="o">=</span> <span class="n">unpack_weigths_gen</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">weights_meta</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Deltas</span><span class="p">)):</span>
        <span class="n">Deltas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Deltas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">m</span>
        <span class="k">if</span> <span class="n">reg_lambda</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Deltas</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">Deltas</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="p">(</span><span class="n">reg_lambda</span> <span class="o">/</span> <span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">thetas_gen</span><span class="o">.</span><span class="n">next</span><span class="p">()[:,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">pack_weigths</span><span class="p">(</span><span class="o">*</span><span class="nb">tuple</span><span class="p">(</span><span class="n">Deltas</span><span class="p">))</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[12]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="k">def</span> <span class="nf">minibatch</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="k">if</span> <span class="n">batch_size</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">m</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">))</span>
    <span class="n">max_batchs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">m</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">))</span>
    
    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">m</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_batchs</span><span class="p">):</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">X</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[13]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="k">def</span> <span class="nf">mb_gd</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">func_prime</span><span class="p">,</span> <span class="n">thetas0</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s">&#39;batch_size&#39;</span><span class="p">]</span>
    <span class="n">maxiter</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s">&#39;maxiter&#39;</span><span class="p">]</span>
    <span class="n">learning_rate</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s">&#39;learning_rate&#39;</span><span class="p">]</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s">&#39;tol&#39;</span><span class="p">]</span>
    <span class="n">disp</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s">&#39;disp&#39;</span><span class="p">]</span>
    <span class="n">thetas</span> <span class="o">=</span> <span class="n">thetas0</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">prevJ</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">_X</span><span class="p">,</span> <span class="n">_y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxiter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">minibatch</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)):</span>
        <span class="n">thetas</span> <span class="o">=</span> <span class="n">thetas</span> <span class="o">-</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="n">func_prime</span><span class="p">(</span><span class="n">thetas</span><span class="p">,</span> <span class="n">_X</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="n">newJ</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">thetas</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">newJ</span><span class="p">)</span> <span class="ow">and</span> <span class="n">newJ</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="s">&quot;inf&quot;</span><span class="p">):</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">newJ</span> <span class="o">-</span> <span class="n">prevJ</span><span class="p">)</span>
            
            <span class="n">prevJ</span> <span class="o">=</span> <span class="n">newJ</span>
            <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">tol</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">maxiter</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">disp</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">i</span><span class="p">,</span> <span class="n">newJ</span>    
        <span class="k">if</span> <span class="n">callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">callback</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">thetas</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">thetas</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[14]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="k">def</span> <span class="nf">mb_rmsprop</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">func_prime</span><span class="p">,</span> <span class="n">thetas0</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s">&#39;batch_size&#39;</span><span class="p">]</span>
    <span class="n">maxiter</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s">&#39;maxiter&#39;</span><span class="p">]</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s">&#39;tol&#39;</span><span class="p">]</span>
    <span class="n">disp</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s">&#39;disp&#39;</span><span class="p">]</span>
    <span class="n">thetas</span> <span class="o">=</span> <span class="n">thetas0</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">prevJ</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">rms</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">_X</span><span class="p">,</span> <span class="n">_y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxiter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">minibatch</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)):</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="n">func_prime</span><span class="p">(</span><span class="n">thetas</span><span class="p">,</span> <span class="n">_X</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="n">rms</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">rms</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
        <span class="n">thetas</span> <span class="o">=</span> <span class="n">thetas</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rms</span><span class="p">))</span>
        <span class="n">newJ</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">thetas</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">newJ</span><span class="p">)</span> <span class="ow">and</span> <span class="n">newJ</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="s">&quot;inf&quot;</span><span class="p">):</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">newJ</span> <span class="o">-</span> <span class="n">prevJ</span><span class="p">)</span>
            <span class="n">prevJ</span> <span class="o">=</span> <span class="n">newJ</span>
            <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">tol</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">maxiter</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">disp</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">i</span><span class="p">,</span> <span class="n">newJ</span>    
        <span class="k">if</span> <span class="n">callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">callback</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">thetas</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">thetas</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[15]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="k">def</span> <span class="nf">mb_scipy</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">func_prime</span><span class="p">,</span> <span class="n">thetas0</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s">&#39;batch_size&#39;</span><span class="p">]</span>
    <span class="n">maxiter</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s">&#39;maxiter&#39;</span><span class="p">]</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s">&#39;tol&#39;</span><span class="p">]</span>
    <span class="n">disp</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s">&#39;disp&#39;</span><span class="p">]</span>
    <span class="n">thetas</span> <span class="o">=</span> <span class="n">thetas0</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">prevJ</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">thetas</span> <span class="o">=</span> <span class="n">thetas0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">_X</span><span class="p">,</span> <span class="n">_y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxiter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">minibatch</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)):</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">thetas</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">func_prime</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;mb_opti&#39;</span><span class="p">],</span> 
                                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">_X</span><span class="p">,</span> <span class="n">_y</span><span class="p">)</span> <span class="o">+</span> <span class="n">args</span><span class="p">,</span>
                                <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;maxiter&#39;</span><span class="p">:</span> <span class="n">options</span><span class="p">[</span><span class="s">&#39;mb_opti_maxiter&#39;</span><span class="p">]})</span>
        <span class="n">thetas</span> <span class="o">=</span> <span class="n">ans</span><span class="o">.</span><span class="n">x</span>
        <span class="n">newJ</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">thetas</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">newJ</span><span class="p">)</span> <span class="ow">and</span> <span class="n">newJ</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="s">&quot;inf&quot;</span><span class="p">):</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">newJ</span> <span class="o">-</span> <span class="n">prevJ</span><span class="p">)</span>
            
            <span class="n">prevJ</span> <span class="o">=</span> <span class="n">newJ</span>
            <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">tol</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">maxiter</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">disp</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">i</span><span class="p">,</span> <span class="n">newJ</span>
        <span class="k">if</span> <span class="n">callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">callback</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">thetas</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">thetas</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[16]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="k">def</span> <span class="nf">mb_opti</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">func_prime</span><span class="p">,</span> <span class="n">thetas0</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s">&#39;mb_opti&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;GD&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mb_gd</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">function_prime</span><span class="p">,</span> <span class="n">thetas0</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s">&#39;mb_opti&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;RMSPROP&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mb_rmsprop</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">function_prime</span><span class="p">,</span> <span class="n">thetas0</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mb_scipy</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">function_prime</span><span class="p">,</span> <span class="n">thetas0</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[17]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="k">class</span> <span class="nc">NN</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden_layers</span><span class="p">,</span> 
                 <span class="n">opti_method</span><span class="o">=</span><span class="s">&#39;MB&#39;</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.000001</span><span class="p">,</span> 
                 <span class="n">mb_opti</span><span class="o">=</span><span class="s">&#39;CG&#39;</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> 
                 <span class="n">mb_opti_maxiter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">disp</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">opti_callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">act_func</span><span class="o">=</span><span class="n">sigmoid</span><span class="p">,</span>
                 <span class="n">epsilon_init</span><span class="o">=</span><span class="mf">0.12</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                 <span class="n">reg_lambda</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">coef0</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_layers</span> <span class="o">=</span> <span class="n">hidden_layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opti_method</span> <span class="o">=</span> <span class="n">opti_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxiter</span> <span class="o">=</span> <span class="n">maxiter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="n">tol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mb_opti</span> <span class="o">=</span> <span class="n">mb_opti</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mb_opti_maxiter</span> <span class="o">=</span> <span class="n">mb_opti_maxiter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disp</span> <span class="o">=</span> <span class="n">disp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opti_callback</span> <span class="o">=</span> <span class="n">opti_callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">act_func</span> <span class="o">=</span> <span class="n">act_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_init</span> <span class="o">=</span> <span class="n">epsilon_init</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span> <span class="o">=</span> <span class="n">random_state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg_lambda</span> <span class="o">=</span> <span class="n">reg_lambda</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coef0</span> <span class="o">=</span> <span class="n">coef0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coef_</span> <span class="o">=</span> <span class="bp">None</span>
    
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coef_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">act_func</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_layers</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">weight_metadata</span> <span class="o">=</span> <span class="n">build_network</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_</span> <span class="o">=</span> <span class="n">weight_metadata</span>
        
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">)</span>
        <span class="n">thetas0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">rand_init</span><span class="p">(</span><span class="n">weight_metadata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_init</span><span class="p">)</span>
        <span class="n">num_labels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        
        <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">options</span><span class="p">[</span><span class="s">&#39;maxiter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxiter</span>
        <span class="n">options</span><span class="p">[</span><span class="s">&#39;disp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disp</span>
        <span class="n">_callback</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opti_method</span> <span class="o">==</span> <span class="s">&#39;MB&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opti_callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">_callback</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">thetas</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coef_</span> <span class="o">=</span> <span class="n">thetas</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">opti_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            
            <span class="n">options</span><span class="p">[</span><span class="s">&#39;mb_opti&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mb_opti</span>
            <span class="n">options</span><span class="p">[</span><span class="s">&#39;batch_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
            <span class="n">options</span><span class="p">[</span><span class="s">&#39;learning_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span>
            <span class="n">options</span><span class="p">[</span><span class="s">&#39;tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span>
            <span class="n">options</span><span class="p">[</span><span class="s">&#39;mb_opti_maxiter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mb_opti_maxiter</span>
            <span class="n">ans</span> <span class="o">=</span> <span class="n">mb_opti</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">function_prime</span><span class="p">,</span> <span class="n">thetas0</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">_callback</span><span class="p">,</span>
                          <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">weight_metadata</span><span class="p">,</span> <span class="n">num_labels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_lambda</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">act_func</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opti_callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">_callback</span><span class="p">(</span><span class="n">thetas</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coef_</span> <span class="o">=</span> <span class="n">thetas</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">opti_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">ans</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">thetas0</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">function_prime</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opti_method</span><span class="p">,</span> 
                                    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">weight_metadata</span><span class="p">,</span> <span class="n">num_labels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_lambda</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">act_func</span><span class="p">),</span>
                                    <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">_callback</span><span class="p">)</span>
            <span class="n">ans</span> <span class="o">=</span> <span class="n">ans</span><span class="o">.</span><span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coef_</span> <span class="o">=</span> <span class="n">ans</span>
</pre></div>

</div>
</div>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<h2 class="ipynb">
  MNIST
</h2>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>Lets see how it good it does the using the MINST dataset: 50k rows for training and 10k validations, 748 features.</p>
<p>For all the optimization algorithms I am going to use 100 iterations using a batch size of 100. Also I only timed the fitting once because it takes a long time and I am lazy, also the difference between iterations when the times are that long are not that significant.</p>
<p>My setup is: Macbook Pro 2.5 GHz Inter Core i5. 16 GB RAM.</p>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[18]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="kn">import</span> <span class="nn">cPickle</span><span class="o">,</span> <span class="nn">gzip</span><span class="o">,</span> <span class="nn">numpy</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s">&#39;mnist.pkl.gz&#39;</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
<span class="n">train_set</span><span class="p">,</span> <span class="n">valid_set</span><span class="p">,</span> <span class="n">test_set</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[19]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">train_set</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">train_set</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[20]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span> <span class="o">=</span> <span class="n">valid_set</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">valid_set</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[21]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span>
</pre></div>

</div>
</div>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<h3 class="ipynb">
  MB-GD
</h3>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>First let's try using a simple gradient decent, the bad part is that one needs to input <a href="http://arxiv.org/abs/1206.1106">the pesky learning rate</a></p>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[22]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="n">nn</span> <span class="o">=</span> <span class="n">NN</span><span class="p">(</span><span class="n">hidden_layers</span><span class="o">=</span><span class="p">[</span><span class="mi">25</span><span class="p">],</span> <span class="n">opti_method</span><span class="o">=</span><span class="s">&#39;MB&#39;</span><span class="p">,</span> <span class="n">mb_opti</span><span class="o">=</span><span class="s">&#39;GD&#39;</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1234</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[23]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%</span><span class="k">timeit</span> <span class="o">-</span><span class="n">n1</span> <span class="o">-</span><span class="n">r1</span> <span class="n">nn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>

</div>
</div>
<div class="vbox output_wrapper">
<div class="output vbox">
<div class="hbox output_area">
<div class="prompt output_prompt"></div>
<div class="output_subarea output_stream output_stdout">
<pre class="ipynb">1 loops, best of 1: 131 s per loop
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[24]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="n">accuracy_score</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">),</span> <span class="n">y_valid</span><span class="p">)</span>
</pre></div>

</div>
</div>
<div class="vbox output_wrapper">
<div class="output vbox">
<div class="hbox output_area">
<div class="prompt output_prompt">Out[24]:</div>
<div class="output_subarea output_pyout">
<pre class="ipynb">0.68469999999999998</pre>
</div>
</div>
</div>
</div>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>It took 131 seconds with a 68.46% accuracy, not amazing, let's give him another 100 iterations by setting the <code>coef0</code> argument.</p>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[25]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="n">nn</span> <span class="o">=</span> <span class="n">NN</span><span class="p">(</span><span class="n">hidden_layers</span><span class="o">=</span><span class="p">[</span><span class="mi">25</span><span class="p">],</span> <span class="n">opti_method</span><span class="o">=</span><span class="s">&#39;MB&#39;</span><span class="p">,</span> <span class="n">mb_opti</span><span class="o">=</span><span class="s">&#39;GD&#39;</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">coef0</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">coef_</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[26]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%</span><span class="k">timeit</span> <span class="o">-</span><span class="n">n1</span> <span class="o">-</span><span class="n">r1</span> <span class="n">nn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>

</div>
</div>
<div class="vbox output_wrapper">
<div class="output vbox">
<div class="hbox output_area">
<div class="prompt output_prompt"></div>
<div class="output_subarea output_stream output_stdout">
<pre class="ipynb">1 loops, best of 1: 135 s per loop
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[27]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="n">accuracy_score</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">),</span> <span class="n">y_valid</span><span class="p">)</span>
</pre></div>

</div>
</div>
<div class="vbox output_wrapper">
<div class="output vbox">
<div class="hbox output_area">
<div class="prompt output_prompt">Out[27]:</div>
<div class="output_subarea output_pyout">
<pre class="ipynb">0.82030000000000003</pre>
</div>
</div>
</div>
</div>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>Much better, more time will probably give better results.</p>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<h3 class="ipynb">
  RMSPROP
</h3>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>RMSPROP is an idea from Geoffrey Hinton which is very simple to implement and removes the learning rate. The idea is to reduce the learning rates of each gradient by a RMS of previous batches.</p>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[28]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="n">nn</span> <span class="o">=</span> <span class="n">NN</span><span class="p">(</span><span class="n">hidden_layers</span><span class="o">=</span><span class="p">[</span><span class="mi">25</span><span class="p">],</span> <span class="n">opti_method</span><span class="o">=</span><span class="s">&#39;MB&#39;</span><span class="p">,</span> <span class="n">mb_opti</span><span class="o">=</span><span class="s">&#39;RMSPROP&#39;</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[29]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%</span><span class="k">timeit</span> <span class="o">-</span><span class="n">n1</span> <span class="o">-</span><span class="n">r1</span> <span class="n">nn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>

</div>
</div>
<div class="vbox output_wrapper">
<div class="output vbox">
<div class="hbox output_area">
<div class="prompt output_prompt"></div>
<div class="output_subarea output_stream output_stdout">
<pre class="ipynb">1 loops, best of 1: 139 s per loop
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[30]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="n">accuracy_score</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">),</span> <span class="n">y_valid</span><span class="p">)</span>
</pre></div>

</div>
</div>
<div class="vbox output_wrapper">
<div class="output vbox">
<div class="hbox output_area">
<div class="prompt output_prompt">Out[30]:</div>
<div class="output_subarea output_pyout">
<pre class="ipynb">0.41310000000000002</pre>
</div>
</div>
</div>
</div>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>Not amazing lets try another 100 iterations.</p>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[31]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="n">nn</span> <span class="o">=</span> <span class="n">NN</span><span class="p">(</span><span class="n">hidden_layers</span><span class="o">=</span><span class="p">[</span><span class="mi">25</span><span class="p">],</span> <span class="n">opti_method</span><span class="o">=</span><span class="s">&#39;MB&#39;</span><span class="p">,</span> <span class="n">mb_opti</span><span class="o">=</span><span class="s">&#39;RMSPROP&#39;</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">coef0</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">coef_</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[32]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%</span><span class="k">timeit</span> <span class="o">-</span><span class="n">n1</span> <span class="o">-</span><span class="n">r1</span> <span class="n">nn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>

</div>
</div>
<div class="vbox output_wrapper">
<div class="output vbox">
<div class="hbox output_area">
<div class="prompt output_prompt"></div>
<div class="output_subarea output_stream output_stdout">
<pre class="ipynb">1 loops, best of 1: 135 s per loop
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[33]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="n">accuracy_score</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">),</span> <span class="n">y_valid</span><span class="p">)</span>
</pre></div>

</div>
</div>
<div class="vbox output_wrapper">
<div class="output vbox">
<div class="hbox output_area">
<div class="prompt output_prompt">Out[33]:</div>
<div class="output_subarea output_pyout">
<pre class="ipynb">0.44140000000000001</pre>
</div>
</div>
</div>
</div>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>Hum... Not really good, lets give <strong>more</strong> time</p>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[34]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="n">nn</span> <span class="o">=</span> <span class="n">NN</span><span class="p">(</span><span class="n">hidden_layers</span><span class="o">=</span><span class="p">[</span><span class="mi">25</span><span class="p">],</span> <span class="n">opti_method</span><span class="o">=</span><span class="s">&#39;MB&#39;</span><span class="p">,</span> <span class="n">mb_opti</span><span class="o">=</span><span class="s">&#39;RMSPROP&#39;</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">coef0</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">coef_</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[35]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%</span><span class="k">timeit</span> <span class="o">-</span><span class="n">n1</span> <span class="o">-</span><span class="n">r1</span> <span class="n">nn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>

</div>
</div>
<div class="vbox output_wrapper">
<div class="output vbox">
<div class="hbox output_area">
<div class="prompt output_prompt"></div>
<div class="output_subarea output_stream output_stdout">
<pre class="ipynb">1 loops, best of 1: 688 s per loop
</pre>
</div>
</div>
<div class="hbox output_area">
<div class="prompt output_prompt"></div>
<div class="output_subarea output_stream output_stderr">
<pre class="ipynb">-c:2: RuntimeWarning: overflow encountered in exp
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[36]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="n">accuracy_score</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">),</span> <span class="n">y_valid</span><span class="p">)</span>
</pre></div>

</div>
</div>
<div class="vbox output_wrapper">
<div class="output vbox">
<div class="hbox output_area">
<div class="prompt output_prompt">Out[36]:</div>
<div class="output_subarea output_pyout">
<pre class="ipynb">0.69699999999999995</pre>
</div>
</div>
</div>
</div>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>Wow, that took a while, and not amazing results to be honest.</p>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<h3 class="ipynb">
  MB-CG
</h3>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>Finally my personal favorite is just to use the scipy optimization methods, one has to be careful though because most are for batch optimization. But the Conjugate Gradient and L-BFGS-B works on mini-batches. Personally I prefer CG because gave me better results.</p>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[37]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="n">nn</span> <span class="o">=</span> <span class="n">NN</span><span class="p">(</span><span class="n">hidden_layers</span><span class="o">=</span><span class="p">[</span><span class="mi">25</span><span class="p">],</span> <span class="n">opti_method</span><span class="o">=</span><span class="s">&#39;MB&#39;</span><span class="p">,</span> <span class="n">mb_opti</span><span class="o">=</span><span class="s">&#39;CG&#39;</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1234</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[38]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%</span><span class="k">timeit</span> <span class="o">-</span><span class="n">n1</span> <span class="o">-</span><span class="n">r1</span> <span class="n">nn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>

</div>
</div>
<div class="vbox output_wrapper">
<div class="output vbox">
<div class="hbox output_area">
<div class="prompt output_prompt"></div>
<div class="output_subarea output_stream output_stdout">
<pre class="ipynb">1 loops, best of 1: 218 s per loop
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[39]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="n">accuracy_score</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">),</span> <span class="n">y_valid</span><span class="p">)</span>
</pre></div>

</div>
</div>
<div class="vbox output_wrapper">
<div class="output vbox">
<div class="hbox output_area">
<div class="prompt output_prompt">Out[39]:</div>
<div class="output_subarea output_pyout">
<pre class="ipynb">0.89280000000000004</pre>
</div>
</div>
</div>
</div>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<h4 class="ipynb">
  Comparison
</h4>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's look at the results in a beautiful pandas DataFrame.</p>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[42]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell vbox">
<div class="input hbox">
<div class="prompt input_prompt">In&nbsp;[46]:</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">266</span><span class="p">,</span> <span class="mf">0.8203</span><span class="p">],</span> <span class="p">[</span><span class="mi">700</span><span class="p">,</span> <span class="mi">962</span><span class="p">,</span> <span class="mf">0.6969</span><span class="p">],</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">218</span><span class="p">,</span> <span class="mf">0.8928</span><span class="p">]],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GD&#39;</span><span class="p">,</span> <span class="s">&#39;RMSPROP&#39;</span><span class="p">,</span> <span class="s">&#39;CG&#39;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;# Iter&#39;</span><span class="p">,</span> <span class="s">&#39;Time [s]&#39;</span><span class="p">,</span> <span class="s">&#39;Accuracy&#39;</span><span class="p">])</span>
</pre></div>

</div>
</div>
<div class="vbox output_wrapper">
<div class="output vbox">
<div class="hbox output_area">
<div class="prompt output_prompt">Out[46]:</div>
<div class="output_subarea output_pyout output_html rendered_html">
<div style="max-height:1000px;max-width:540px;overflow:auto;">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th># Iter</th>
      <th>Time [s]</th>
      <th>Accuracy</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>GD</th>
      <td> 200</td>
      <td> 266</td>
      <td> 0.8203</td>
    </tr>
    <tr>
      <th>RMSPROP</th>
      <td> 700</td>
      <td> 962</td>
      <td> 0.6969</td>
    </tr>
    <tr>
      <th>CG</th>
      <td> 100</td>
      <td> 218</td>
      <td> 0.8928</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>In all three benchmarks the winner was CG. Personally I was disapointed about RMSPROP, probally my implementation is wrong, if anyone can spot the mistake I will be happy to know.</p>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<h2 class="ipynb">
  Conclusions
</h2>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>The scipy optimization methods are amazing, for basic stuff just use those. Don't have to specify a learning rate and are faster.</p>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>Something that is not going to be in this post but I want to try is to use mini-batches until some point and then use full-batch to do some fine tuning when mini-batch is not working anymore.</p>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>Also people suggested to use a lookup table for the sigmoid. I tried but the accuracy I got was really bad, I have to check that code again.</p>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>As improvements I would love to do is create a general Minibatch optimization and probably use a decorator on RMPSPROP and other optimization options just to follow DRY. Or why not use an existing implemenatation because there are many python implementations of these and more algorithms online, just to name a few I found: <a href="https://github.com/amarack/python-rl">python-rl</a> and <a href="https://github.com/BRML/climin">climin</a>.</p>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>I think I have learned enough about neural networks for my personal satisfaction, so this is probablly the last iteration of my Neural network. I will definitely keep looking at the updates of NN research but not as almost fulltime as I been doing the past weeks. Is an imposible mission to catch up that amount of information in my free time.</p>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>Having spent almost a month reading about NN my (obvious) conclusion is that researchers are just scratching the surface of what is possible, and the next years are going to be exciting. </p>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>There is even free <a href="http://www.cs.toronto.edu/~gdahl/">python (gpu) implementation</a> of a Deep belief net by one person on Geoffrey Hinton group which I havent look but seams promising and hopefully he will release more code. </p>
</div>
<div class="text_cell_render border-box-sizing rendered_html">
<p>Finally I have to admit that I cheated a little bit on the post. Because the neural network supports multiple hidden layers but I only used one!
<strong>Why?</strong> because I couldn't find a way to make those network converge without full-batch learning, and the MNIST dataset is too big for that. I have tried on the Iris dataset and is working. Don't trust me? try yourself: the code is on <a href="https://github.com/danielfrg/copper">github</a>.</p>
</div></div>
        </div>
    </article>

    <div class="metadata">
        <ul>
            <li>
                <strong>Published:</strong>
                <i><time datetime="2013-07-27T00:00:00">27.07.2013</time></i>
            </li>
            <li>
                <strong>In:</strong>
                <a href="http://danielfrg.github.io/category/machine-learning.html">Machine learning</a>
            </li>
                        <li>
                <strong>Tags:</strong>
                <a href="http://danielfrg.github.io/tag/python.html">python</a> 
                <a href="http://danielfrg.github.io/tag/machine-learning.html">machine learning</a> 
                <a href="http://danielfrg.github.io/tag/neural-networks.html">neural networks</a> 
                            </li>
                        <li>
                <strong>Written by:</strong>
                <a href="http://danielfrg.github.io/author/daniel-rodriguez.html">Daniel Rodriguez</a>
            </li>
        </ul>
    </div>
</div>
        </div>

        <footer>
            <section class='footer'>
    <div class="post social container row-fluid">
        <div class="span3">
            <div class="fb-like" data-send="false" data-layout="button_count" data-show-faces="false"></div>
        </div>
        <div class="span3">
            <a href="https://twitter.com/share" class="twitter-share-button" data-via="danielfrg">Tweet</a>
        </div>

        <div class="span3">
            <div class="g-plusone" data-size="medium" data-annotation="bubble"></div>
        </div>

        <div class="span3 hn">
            <span id="hnews"></span>
        </div>
    </div>

    <div id="disqus_thread" class="comments container"></div>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>

<script src="/theme/js/social.js"></script>
        </footer>


        <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-35523657-2']);
        _gaq.push(['_trackPageview']);

        (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
        </script>
    </body>
</html>